# GitLab CI configuration for building LineageOS
# GitLab runners have more disk space than GitHub Actions

image: ubuntu:22.04

variables:
  GIT_DEPTH: 1
  CCACHE_SIZE: 8G
  USE_CCACHE: 1

build_rom:
  stage: build
  timeout: 6h

  before_script:
    - apt-get update
    - apt-get install -y bc bison build-essential ccache curl flex
      g++-multilib gcc-multilib git gnupg gperf imagemagick
      lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool
      libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2
      libxml2-utils lzop pngcrush rsync schedtool squashfs-tools
      xsltproc zip zlib1g-dev openjdk-11-jdk python3 python-is-python3
      ca-certificates

    # Set up repo
    - mkdir -p ~/bin
    - curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
    - chmod a+x ~/bin/repo
    - export PATH=~/bin:$PATH

    # Configure git
    - git config --global user.name "GitLab CI"
    - git config --global user.email "ci@gitlab.com"

    # Set up ccache
    - export CCACHE_DIR=$CI_PROJECT_DIR/.ccache
    - ccache -M $CCACHE_SIZE

  script:
    - export PATH=~/bin:$PATH

    # Free up disk space by removing unnecessary packages
    - apt-get clean
    - rm -rf /var/lib/apt/lists/*

    # Initialize LineageOS repo
    - repo init -u https://github.com/LineageOS/android.git -b lineage-18.1 --depth=1

    # Sync with minimal history
    - repo sync -c --no-clone-bundle --no-tags --optimized-fetch --prune -j$(nproc)

    # Clone device tree (current repo)
    - rm -rf device/samsung/on7xelte
    - git clone $CI_REPOSITORY_URL device/samsung/on7xelte --depth=1

    # Clone kernel
    - git clone --depth=1 https://github.com/exynos7870/android_kernel_samsung_exynos7870.git
      kernel/samsung/exynos7870

    # Clone vendor blobs
    - git clone https://github.com/Et18n/android_vendor_samsung_on7xelte
      vendor/samsung/on7xelte --depth=1

    # Build
    - source build/envsetup.sh
    - lunch lineage_on7xelte-userdebug
    - mka bacon -j$(nproc)

  artifacts:
    name: "lineage-18.1-on7xelte-$CI_COMMIT_SHORT_SHA"
    paths:
      - out/target/product/on7xelte/lineage-*.zip
      - out/target/product/on7xelte/recovery.img
    expire_in: 30 days
    when: on_success

  cache:
    key: lineage-ccache
    paths:
      - .ccache/

  only:
    - main
    - master
    - tags

  # GitLab's free tier still might struggle, but has better chance than GitHub
  # Consider using a self-hosted GitLab runner on a machine with more storage
